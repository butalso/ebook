## 数据库分片
### 什么是分片
分片(Sharding)是一种与水平切分相关的数据库架构模式，将一个表里面的行，分成多个不同的表的做法（称为分区）。每个区都有相同的模式和列，但每个表有完全不同的行。同样，每个分区中保存的数据都是唯一的，并且与其他分区中保存的数据无关。
### 分片的优点 VS 缺点
优点：
* 可以添加更多的机器，允许更多的流量，实现水平扩展（向外扩展）。
* 加快查询响应时间，通过将一个表拆分成多个，查询过程中便利更少的行，并且返回结果集速度加快。
* 减少宕机的影响，对于分片数据库，宕机可能只会影响单个分片，使应用程序更加稳定可靠。

缺点（风险）：
* 复杂度提高：正确实现分片数据库架构，是十分复杂的。如果操作不当，分片过程可能会造成数据丢失或表损坏，风险大。同时，即使正确的进行了分片，也可能对团队工作流程产生重大影响。与从单个入口点入口点访问和管理数据不同，用户必须跨多个分片管理数据。
* 分片不平衡：不恰当的分片方式，会造成分片不平衡，得不到分片的好处。
* 架构难以回滚： 一档是数据库进行了分片，就很难在将其恢复到未分片架构

### 分片算法
一个好的分片算法，应该具备以下特点
* 分布均匀，即每个分片的数据量要尽可能相近。
* 负载均衡，及每台设备上的请求量要尽可能相近。
* 扩缩容时产生的数据迁移尽可能少。
#### 范围分片
一般适用于key为整形的情况，每台设备上存放相同大小的号段区间。

优点：
* 实现简单

缺点：
* 数据可能分布不均匀，如小号段数据量可能比大号段数据量要大
* 各个号段数据热度可能不一致，导致各个设备负载不均衡
#### 索引分片
在检索表中存储key值和分片的映射关系，通过查找检索表来查找数据所在的分片，确定数据分布。

优点：
* 比较灵活：可以对每个key都存储映射关系，也可以结合划分号段的方式来减小检索表的容量。

缺点：
* 每次查询或写入都要连接到检索表，可能会对应用程序性能产生不利影响。同时，检索表如果出现单点故障，也会影响数据库写入新数据和访问现有数据的能力。

#### 哈希分片
计算key的哈希值，然后对节点数量取模。

优点：
* 实现简单
* 数据分布均匀，热点数据均匀

缺点：
* 扩缩容会产生大量的数据迁移
#### 一致性哈希分片
1. 一致性哈希算法将整个哈希值空间组织成一个虚拟的圆环，整个空间按顺时针方向组织
2. 将各个服务器进行hash，一个服务器节点可以计算成多个哈希值，每个哈希值都可以在圆环相应的位置防止一个虚拟节点
3. 计算key的哈希值，沿环顺时针方向行走，遇到的第一个节点就是其该定位到的服务器。

优点：
* 实现简单
* 数据分布均匀
* 扩缩容数据迁移较少

#### 如何判断是否应该分片
究竟该不该采用分片的数据库架构一直是备受争议的问题。一些人认为当数据库达到一定量级的时候，采用分片架构是必然的；另一些人则认为由于操作复杂，除非是万不得已，否则不应该使用分片架构。

由于其复杂性，数据库分片架构多用于处理非常大量的数据。以下这些场景中，对数据库分片可能会非常有用：
* 应用数据不断增长，超出了单点数据库的存储能力。
* 数据库的读写超出了单点数据库或只读从库（读写分离架构下）的处理能力，从而导致了响应慢或超时。
* 应用所需的网络带宽超出了单点数据库或只读从库的可用带宽，从而导致了响应慢或超时。

对数据库分片之前，你最好先尝试其他的方式来优化你的数据库。比如：
* 使用远程数据库。如果你有一个庞大的应用，其所有的组件都依赖于同一个数据库服务器，你可以考虑将数据库迁移到一台单独的机器上来提高其性能。这不会像数据库分片那样复杂，因为所有的数据库表都还是完整的。并且，这种方式还允许你能够抛开其他基础设施，单独地对数据库做纵向扩展。
* 使用缓存。如果应用受制于读数据的性能，使用缓存是改进性能的一种方式。缓存通过将请求过的数据暂时地保存在内存中，加速后续的数据访问。
* 创建若干个只读从库。另一种能够改进读取性能的方法是将数据从主库拷贝到若干个从库中。这样一来，新的写操作将使用主库，之后再拷贝到从库中，而读操作将使用从库。这种读写分离的模式使得每一台机器都不会承受过大的负载，有助于防止机器变慢甚至崩溃。值得注意的是，创建只读从库需要更多的计算资源、花更多的钱，某些情况下，这些将会使你步履维艰。
* 升级服务器。一些情况下，升级数据库服务器的配置比数据库分片简单多了。对比创建只读从库，升级服务器配置可能会花更多的钱。因此，除非这真的是你最好的选择，否则不应该对机器扩容。

谨记只有当你的应用或者网站增长超过了一定量级的时候，以上这些方法都不足以有效地改进其性能的时候，数据库分片才真的是最佳选择。

## 参考链接
<https://zhuanlan.zhihu.com/p/57185574>
<https://blog.csdn.net/shmnh/article/details/73522409>